---
title: RBIF112 - Assignment 4
author: "Author: Neshita Kipuw"
date: "Last update: `r format(Sys.time(), '%d %B, %Y')`" 
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    fig_caption: yes
    code_folding: hide
    number_sections: true
  pdf_document:
    toc: true
vignette: >
    %\VignetteIndexEntry{Text}
    %\usepackage[utf8]{inputenc}
    %\VignetteEngine{knitr::rmarkdown}
fontsize: 15pt
editor_options: 
  chunk_output_type: console
---

<style>
pre code, pre, code {
  white-space: pre !important;
  overflow-x: auto !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
body {
text-align: justify}
</style>
---  

```{r, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, class.source = "fold-hide", fig.height=5, fig.width=12, results='hide', cache=FALSE}
knitr::opts_chunk$set(echo = TRUE)
homedir <- "H:/My Drive/RBIF112/wk4/HW-files" # object containing a home directory path in R ( in this code chunk), and in python (The next code chunk).
setwd(homedir)
```
<br>
<br>


# Question 1  
  
A function to create an individual corpus of gene ontology information for each gene and save them individually in a directory. Then, another function that will stream through these files and compute the similarity between each gene ontology corpus and a set of search terms.  
The search terms: “age insulin glucose cholesterol triglyceride lipoprotein ahi odi bun creatnine blood pressure weight”  
  
The following code block set up the individual files of gene ontology obtained from biomaRt and also consist of the transcription factor directory that was set up in the notes.  
*Note: the code below was executed and successfully established the intended Corpora. Due to the lengthy processing time, the code block will not be executed in R markdown when knitting to HTML. Subsequent to this, the rest of the code blocks will execute. Refer to R markdown file for details.*
<br>  
  
```{r, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, class.source = "fold-show", fig.height=5, fig.width=8, results='show', cache=FALSE}
## directory containing each corpus consisting the transcription factor directory
library(data.table)
library(biomaRt)

# load data for genes and transcription factors
TXDT <- fread(file.path("H:/My Drive/RBIF112/wk4/HW-files/input_data/input_data", "TranscriptionFactors.txt"), header = TRUE)
Genes <- fread(file.path("H:/My Drive/RBIF112/wk4/HW-files/input_data/input_data", "HumanMouseGenes.txt"), header = TRUE)
# filter for human genes only
Genes <- Genes[Common_Name == "Human",]
# add a column to indicate if the gene is a transcription factor
Genes[,TranscriptionFactor := 0,]
# set the transcription factor column to 1 for genes that are in the TXDT data frame
Genes[external_gene_name %in% TXDT$prot,]$TranscriptionFactor <- 1
# convert the values in the external gene name column to uppercase letters
Genes$external_gene_name <- toupper(Genes$external_gene_name)

# get the gene names from the human genes
name <- Genes$external_gene_name
# set up the biomaRt object
myMart <- useMart("ENSEMBL_MART_ENSEMBL")
# listDatasets(myMart)  # optional
# use the biomaRt object to get the genes names for the human genes
myMart <- useMart("ENSEMBL_MART_ENSEMBL", dataset="hsapiens_gene_ensembl")
# listAttributes(myMart)[1:200,] # Choose data types you want to download


go <- getBM(attributes=c("wikigene_name", "go_id", "name_1006", "definition_1006"), mart=myMart, values = name, filters = 'wikigene_name')
go <- data.table(go)
go <- go[(go$wikigene_name %in% name),][,new:=paste0(.SD,collapse=" "),by=seq_along(wikigene_name)][,c("go_id", "name_1006", "definition_1006") := NULL]
go[,TranscriptionFactor := 0,]
go[wikigene_name %in% TXDT$prot,]$TranscriptionFactor <- 1
fwrite(go, "TFGeneOntology.txt")
go <- fread(file.path(homedir, "TFGeneOntology.txt"))
data.table(as.data.frame(head(go, 5)))

txname <- go[!duplicated(go$wikigene_name),]$wikigene_name
CollapsedGO <- data.table()

for(i in 1:length(txname)){
  def1 <- paste(go[wikigene_name == txname[i]]$new, collapse = " ")
  nam <- paste(txname[i], "\n", collapse = "")
  def <- paste(nam, def1, collapse = " ")#
  fnam <- paste("./newcorpus/", i, "_", txname[i], ".txt", collapse = ""); fnam <- gsub(" ", "", fnam)#; fnam
  write.table(def, fnam, row.names=FALSE, quote=FALSE, sep="\t")
}
```
<br>  
<br>  
 
The following code blocks will perform python in R, to create a function that will go through each file to match with the search terms, and calculate the cosine similarity. The result will be a data frame containing the gene names and the cosine similarity score, sorted in descending order.
<br>  
```{r, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, class.source = "fold-show", fig.height=5, fig.width=12, results='hide', cache=FALSE}
# required package for the execution of python code from R
library(reticulate) 
# check the path of python
# Path to the directory where python is stored on my computer
use_python("C:/Users/nessi/miniconda3/envs/hw1/python.exe")

```
  
```{python, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, class.source = "fold-show", fig.height=8, fig.width=12, results='show', cache=FALSE}
import os
import re
import nltk
import sklearn
import pandas as pd
import numpy as np
from nltk.corpus.reader.plaintext import PlaintextCorpusReader
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import linear_kernel

# set the working directory
homedir = 'H:/My Drive/RBIF112/wk4/HW-files'
os.chdir(homedir)

# set the directory for the corpus and read in a single corpus from this directory
directory = './newcorpus'

# set the search terms for the corpus
terms = "age insulin glucose cholesterol triglyceride lipoprotein ahi odi bun creatinine blood pressure weight"

# set a list of search terms
fincorpus = [terms]
# set a directory for the corpus
corpusdir = directory
# read in the corpus
newcorpus = PlaintextCorpusReader(corpusdir, '.*')
# print the first 5 file ids
newcorpus.fileids()[:5]


## define function to compute gene similarity between gene ontology corpora and a set of search terms
# arguments include the corpus directory & the search terms
# returns a data frame with the gene names and their cosine similarity scores
def compute_gene_similarity(directory: str, search_terms: str):
    # read in the corpus
    corpus = PlaintextCorpusReader(directory, '.*')
    # create a list
    results = []
    # loop through the directory
    for fileid in corpus.fileids():
      # get the text from the file
      text = corpus.raw(fileid).strip()
      if not text:   # skip empty files
        continue
        
      # create corpus [search_terms, document]
      fincorpus = [search_terms, text]
      
      # create a tfidf vectorizer & fit the vectorizer to the corpus
      tfidf = TfidfVectorizer().fit_transform(fincorpus)
      
      ## compute the cosine similarities
      # the linear_kernal function is used to compute the cosine similarities
      # the tdidf[0:1] is the first row of the tfidf matrix
      # the tfidf matrix is the matrix of tfidf values for the corpus
      # the flatten() function is used to convert the matrix to a 1D array
      cosine_sim = linear_kernel(tfidf[0:1], tfidf).flatten()
      
      # append gene names & cosine similarity results  
      results.append({
            "Gene_Name": os.path.splitext(fileid)[0],
            "cosine_similarity": float(cosine_sim[1])
        })
    
    if not results:
      return pd.DataFrame(columns=["Gene_Name", "cosine_similarity"])
    
    # return data frame with gene names and cosine similarity scores
    df = pd.DataFrame(results)
    df = df.sort_values(by="cosine_similarity", ascending=False).reset_index(drop=True)
    return df


# specify the directory, search terms, and number of top genes to return
search_terms = "age insulin glucose cholesterol triglyceride lipoprotein ahi odi bun creatinine blood pressure weight"
directory = "newcorpus/"
# execute the function
df_results = compute_gene_similarity(directory, search_terms)

# return the data frame with the gene names and cosine similarity scores
print(df_results.head(20))


# load packages for plots
import matplotlib.pyplot as plt
import seaborn as sns

## plot histogram of cosine similarity scores
def plot_similarity_distribution(df, bins=100):
  plt.figure(figsize=(8,5))
  sns.histplot(df["cosine_similarity"], bins=bins, kde=True, color="steelblue")
  plt.title("Distribution of Cosine Similarity Score")
  plt.xlabel("Cosine similarity")
  plt.ylabel("Frequency")
  plt.show()
  
plot_similarity_distribution(df_results)

## bar plot of top 20 similarity score
def plot_top_genes(df, top_n=20):
  top_df = df.head(top_n)

  plt.figure(figsize=(4,6))
  sns.barplot(
    data = top_df,
    x = "cosine_similarity",
    y = "Gene_Name",
    palette = "viridis",
  )
  plt.title(f"Top 20 Genes by Cosine Similarity", fontsize =14)
  plt.xlabel("Cosine similarity")
  plt.ylabel("Gene name")
  plt.tight_layout()
  plt.show()

plot_top_genes(df_results, top_n=20)

```
<br>
  
**Discussion:**  
The distribution of the cosine similarity scores shows a highly skewed pattern, where there is a major concentration of genes near or at zero -- indicating no relationship with the search terms -- and a long tail of very few genes that achieve >0.02 similarity scores. The maximum observed similarity score is 0.08, which is only a modest improvement. This distribution suggests that most genes in the ontology corpus have little to no functional relationship with the metabolic syndrome and cardiovascular risk factors represented by the search terms.  
The top 20 genes are more similar to the search terms, compared to the majority of the genes. The leading genes, such as APOM, APOC2, APOC3, and APOA2, have the highest similarity scores ranging from 0.06 to 0.08 which is reasonable given these are apolipoprotein genes that are directly involved in lipid metabolism and lipoprotein function. Other genes like G6PC2, APOBR, CETP, with similarity scores of 0.04-0.06, are also reasonable as these are genes involved in glucose homeostasis and members of the apolipoprotein family.  
The results overall indicate that the similarity function was able to provide good specificity in identifying genes with established roles in lipid metabolism, cholesterol regulation, glucose homeostasis, and cardiovascular risk factors. The concentration of apolipoprotein genes in the top results makes biological sense, as these proteins are central to lipid transport and directly relate to cholesterol, triglycerides, and cardiovascular health - related to the search terms. The modest overall similarity scores, with a maximum of 0.08, likely reflect the limited, technical nature of gene ontology annotations compared to the relatively broad search terms; however, the ranking successfully identified and prioritized functionally relevant genes.
<br>
<br>  
  
  
  
# Question 2  
  
A loop removes one word at a time from the search terms. Then, the variance among all the results for each gene is plotted. Finally, the top 5 genes from each iteration are obtained, and the similarity scores calculated for each iteration is plotted. Which term(s), when removed, reduce the similarity scores the most?


```{python, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, class.source = "fold-show", fig.height=5, fig.width=8, results='show', cache=FALSE}

## Removing search terms one at a time and recalculate cosine similarity
# loop function to iteratively remove one search term
# takes in 3 parameters: path to directory, search terms, and top 5 genes to return
# returns a data frame with gene name, similarity score, and the removed term (to keep track)

def remove_one_term(directory: str, search_terms: str, top_n: int=5):
  # grab the search terms
  terms = search_terms.split()
  # create a list for results
  results = []
  
  # loop through the search terms
  for i, term in enumerate(terms):
    # remove one term at a time
    # the join() function is used to join the terms with a space
    # the enumerate() function is used to get the index of the term
    # the list comprehension is used to create a list of terms without the current term
    removed_term = " ".join([t for j, t in enumerate(terms) if j !=i])
    
    # reuse the similarity function from previous section
    df = compute_gene_similarity(directory, removed_term)
    
    # if the data frame is not empty, get the top n genes
    if not df.empty:
      # get the top n genes
      # the head() function is used to get the top n genes
      # the copy() function is used to copy the data frame
      top_df = df.head(top_n).copy()
      # add the removed term to the data frame to keep track
      top_df["Removed_Term"] = term
      results.append(top_df)
    
  if results:
    # concatenate the data frames
    # the concat() function is used to concatenate the data frames
    # the ignore_index = True is used to ignore the index of the data frames
    return pd.concat(results, ignore_index = True)
  else:
    # return a data frame with the columns removed terms, gene name, and cosine similarity
    return pd.DataFrame(columns=["Removed_Terms", "Gene_Name", "cosine_similarity"])

# specify the parameters for the function
search_terms = "age insulin glucose cholesterol triglyceride lipoprotein ahi odi bun creatinine blood pressure weight"
directory = "newcorpus/"
# execute the function
new_results = remove_one_term(directory, search_terms, top_n=5)

print(new_results)
```
<br>  
<br>  
  
```{python, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, class.source = "fold-show", fig.height=5, fig.width=8, results='show', cache=FALSE}
## plot the results as a heatmap
import seaborn as sns
import matplotlib.pyplot as plt

# heatmap plot of similarity scores of top 5 genes for each removed term
# takes in paramters: output data frame and number of top genes
def plot_heatmap(new_results: pd.DataFrame, top_n: int=5):
  # add rank column within each removed term
  new_results = new_results.copy()
  # add a rank column after each removed term based on "top 5" genes at each iteration
  # the groupby() function is used to group the data by the removed term
  # the cumcount() function is used to add a rank column based on the 
  # number of rows in each group
  # the + 1 is used to add 1 to the rank column because the cumcount() 
  # function starts at 0
  new_results["Rank"] = new_results.groupby("Removed_Term").cumcount() + 1
  
  # pivot for heatmap to better visualize the data
  # pivot rearranges the data frame so that the removed term are the rows,
  # and the ranks are the columns
  pivot_df = new_results.pivot(
    index = "Removed_Term",
    columns = "Rank",
    values = "cosine_similarity"
  )

  plt.figure(figsize=(5,8))
  sns.heatmap(
    pivot_df,
    # annotate heatmap with similarity score
    annot=True,
    # format the score to 3 decimal places
    fmt=".3f",
    # color the map
    cmap="viridis",
    # label the color bar
    cbar_kws={'label': 'Cosine similarity'}
  )
  
  plt.title(f"Top 5 Similarity Score post-Term Removal", fontsize=14)
  plt.xlabel("Rank")
  plt.ylabel("Removed Term")
  plt.tight_layout()
  plt.show()
  
# execute function and plot heatmap
plot_heatmap(new_results, top_n=5)

```
<br>  
**Discussion:**  
Based on the results and the corresponding heatmap, the search terms lipoprotein, cholesterol, and triglycerides were the most impactful. While the rest of the terms blood, age, ahi, bun, creatinine, glucose, insulin, odi, pressure, and weight, show minimal impact with similarity scores remaining high ~0.088 in Rank 1 and declining through the ranks. Lipoprotein shows the most significant reduction in similarity score across the ranks, with a the highest score of 0.058 in Rank 1 down to 0.041. Similarly, cholesterol's highest score is 0.060 in Rank 1, 0.074 for triglycerides, and both continue to decrease down to ~0.05 across the ranks.  
The term lipoprotein is most critical because it directly matched the apolipoprotein genes that showed up as the top genes in the previous section. It would seem that removing this term eliminated the strongest word/semantic connection between the search terms and the most relevant genes. This suggests that lipoprotein-related genes are the key biological targets for the search of metabolic/cardiovascular phenotype.  
Similarly with cholesterol and triglycerides, they represent the primary metabolic biomarkers that are either regulated and/or transported by lipoproteins. The removal of these terms reduces the context that connects the appropriate genes to the phenotype search. The rest of the search terms may be quite distant from the key gene functions in this context. It is surprising that insulin or glucose does not show significant impact; however, glucose metabolism may be less mentioned in the corpus or different terms are used in this case.